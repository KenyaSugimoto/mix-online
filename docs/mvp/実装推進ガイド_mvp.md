# Mix Stud Online 実装推進ガイド（MVP）

Version: v1.2  
Last Updated: 2026-02-11  
参照要件: [`要件定義書_mvp.md`](./要件定義書_mvp.md)  
参照設計: [`詳細設計書_mvp.md`](./詳細設計書_mvp.md)  
APIリファレンス閲覧: [`APIリファレンス閲覧ガイド_mvp.md`](./APIリファレンス閲覧ガイド_mvp.md)  
進捗管理: [`進捗管理シート_mvp.md`](./進捗管理シート_mvp.md)

---

## 1. 本ガイドの目的

- 品質優先で、AIエージェント委譲型の開発を安定運用する
- 「何から着手するか」「完了とみなす条件は何か」を明確にする
- 仕様・実装・テスト・ドキュメント更新を1サイクルで回す

---

## 2. 開発原則（品質優先）

- **仕様先行**: 実装前に必ず `docs/mvp/` の根拠を明示する
- **小さく統合**: 1タスク = 1責務（レビューしやすいサイズ）
- **テスト同時実装**: ロジック変更とテスト追加を同一PRで完結
- **契約維持**: OpenAPI/AsyncAPIと実装差分を残さない
- **契約値参照**: 契約由来のenum値は文字列直書きせず `@mix-online/shared` の定数を参照する
- **履歴明確化**: 進捗と意思決定を必ず記録する

---

## 3. 全体フロー

1. `docs/mvp/進捗管理シート_mvp.md` の `Next` から着手対象を1つ選ぶ
2. 対象タスクの受け入れ条件（Acceptance Criteria）を明文化する
3. AIエージェントへ実装依頼（テンプレート使用）
4. 実装 + 単体テスト + 型/静的チェック実行
5. 仕様差分があれば `docs/mvp/` を更新
6. PRレビュー（仕様整合・回帰・運用リスク）
7. マージ後に進捗管理シートを更新

---

## 4. フェーズ分割（推奨着手順）

## Phase 0: 基盤固定

- 目的: 開発品質を担保する最小基盤を揃える
- 主タスク:
  - workspaceの `lint/typecheck/test` を常時グリーンに保つ
  - `packages/shared` の共通型を仕様準拠で整理
  - エラーハンドリング・ログ方針を決める
- 完了条件:
  - `pnpm lint`, `pnpm typecheck`, `pnpm test` が通る
  - 共通型に対するテストが追加されている

## Phase 1: データ層確定

- 目的: DBスキーマと永続化境界を先に安定させる
- 主タスク:
  - `supabase/migrations/` をDDL正本として運用し、差分管理手順を固定する
  - Repository層のインターフェースを定義
  - seed投入・ローカル起動手順を確立
- 完了条件:
  - マイグレーションが再現可能
  - 主要テーブルのCRUDテストが成立

## Phase 2: API契約実装

- 目的: ロビー/履歴などHTTP APIを契約駆動で実装
- 主タスク:
  - OpenAPIの各エンドポイントに対するハンドラ実装
  - バリデーション/認可/エラーコード整備
  - APIテスト（正常系/異常系）
- 完了条件:
  - OpenAPI記載のMVP対象エンドポイントが実装済み
  - 契約テストで主要ケースが保証される

## Phase 3: Realtime + Game Engine

- 目的: Table Actorを中核にゲーム進行を成立させる
- 主タスク:
  - WebSocket接続・再接続・セッション再開
  - `GameRule` 抽象と StudHi/Razz/Stud8 実装
  - イベントログ永続化と復元
- 完了条件:
  - 1ハンド進行（配札〜清算）が自動テストで通る
  - 再接続時の状態復元が検証済み

## Phase 4: Web統合

- 目的: ロビー→着席→プレイ→結果表示の最短導線を完成
- 主タスク:
  - ロビー画面・卓画面の最小UI実装
  - Realtimeイベント購読で状態同期
  - エラー/切断時UIの整備
- 完了条件:
  - E2EシナリオのMVP必須ケースが通る
  - UX上の致命的ブロッカーがない

## Phase 5: リリース準備

- 目的: 本番運用可能な状態まで品質を引き上げる
- 主タスク:
  - 監視/ログ/運用手順の明文化
  - 退席・切断・タイムアウト系の回帰確認
  - リリース判定チェックリスト実施
- 完了条件:
  - P0/P1バグがゼロ
  - 運用手順を第三者が再現可能

---

## 5. 1タスクの実行手順（AI委譲）

1. 対象機能の参照元を `docs/mvp/` から列挙  
2. 受け入れ条件を3〜7個で定義  
3. 実装（必要ならリファクタ含む）  
4. テスト追加（単体優先、必要に応じ統合）  
5. `pnpm lint` / `pnpm typecheck` / `pnpm test` 実行  
6. 仕様差分のドキュメント更新  
7. 進捗管理シート更新（ステータス・リスク・決定事項）

---

## 6. Definition of Done（DoD）

以下をすべて満たしたときのみ完了:

- 対応範囲が要件/設計にトレース可能
- 実装とテストが同一PRに含まれる
- `pnpm lint` / `pnpm typecheck` / `pnpm test` が成功
- 既存機能への回帰リスクが評価されている
- `docs/mvp/進捗管理シート_mvp.md` が更新されている

---

## 7. PR運用ルール（推奨）

- 1PRあたりの主目的は1つ
- 仕様変更を伴う場合は関連ドキュメントを同時更新
- レビュー観点:
  - 仕様整合（要件/詳細設計/OpenAPI/AsyncAPI）
  - 障害時の挙動（切断・タイムアウト・再試行）
  - テストの妥当性（境界値・異常系）

---

## 8. 最初の1〜2週間の推奨着手順

1. Phase 0完了（品質ゲート固定）
2. Phase 1のマイグレーション確立
3. ロビーAPI（`/api/lobby/tables`）を契約準拠で本実装化
4. `進捗管理シート` で週次レビューを開始

---

## 9. 品質ゲート実行手順（M0-01）

品質ゲートは必ず次の順で実行する。

1. `pnpm lint`
2. `pnpm check:contract-literals`
3. `pnpm typecheck`
4. `pnpm test`

この順序にする理由:

- `lint` で静的な記述問題を最速で検知し、後続の調査コストを下げる
- `check:contract-literals` で契約由来enumのハードコードを早期に検知し、仕様変更時の追従漏れを防ぐ
- `typecheck` で契約/型差分を確定してから、`test` の実行結果を読む
- `test` は最終確認として実行し、仕様挙動の回帰を評価する

### 失敗時の修正方針（一次切り分け）

1. `lint` 失敗時:
   - 自動修正可能なものは `pnpm lint:fix` を実行
   - 残件は対象ファイルに限定して手動修正し、`pnpm lint` を再実行
2. `check:contract-literals` 失敗時:
   - 指摘された文字列リテラルを `@mix-online/shared` の定数参照へ置換
   - 契約定義ファイル/契約整合テストが理由なら、対象を `apps/` から除外しないまま実装側のみ修正
   - 修正後に `pnpm check:contract-literals` を再実行
3. `typecheck` 失敗時:
   - エラー先頭から順に、型定義の不整合か実装の不整合かを分類
   - `packages/shared` の型変更が起点の場合、依存ワークスペースへの影響を同時修正
   - 修正後に `pnpm typecheck` を再実行
4. `test` 失敗時:
   - 再現性確認のため同コマンドを再実行
   - 失敗テストが仕様変更によるものか回帰バグかを判定
   - 仕様変更ならテスト期待値と関連ドキュメントを同時更新、回帰なら実装修正を優先

### 再実行ルール

- いずれかの修正後は、必ず `pnpm lint` → `pnpm check:contract-literals` → `pnpm typecheck` → `pnpm test` を通しで再実行する
- PR前の最終報告には4コマンドの実行結果を明記する

## 10. APIリファレンス閲覧運用（MVP）

- `openapi.yaml` は GitHub Pages 上で自動生成されたHTMLを参照する。
- `asyncapi.yaml` は GitHub Pages 上で AsyncAPI CLI により生成されたHTMLを参照する。
- 生成手順は `scripts/build-api-reference-site.sh` を正とし、`main` push 時に `.github/workflows/docs-pages.yml` で自動反映する。
- 詳細な閲覧URLとローカル確認手順は [`APIリファレンス閲覧ガイド_mvp.md`](./APIリファレンス閲覧ガイド_mvp.md) を参照する。
