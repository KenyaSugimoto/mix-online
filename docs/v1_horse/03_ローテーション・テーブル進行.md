# Mix Online v1 ローテーション・テーブル進行仕様

> 作成日: 2026-02-13 ｜ 対象バージョン: v1 ｜ ステータス: Draft

## 1. 目的

HORSE ローテーションとハンド進行の共通ルールを定義し、実装差異を防ぐ。

## 2. ローテーション仕様

### 2.1 順序

`HOLD_EM -> OMAHA_8 -> RAZZ -> STUD_HI -> STUD_8 -> repeat`

### 2.2 切替単位

- 1ゲームにつき 6 ハンド固定。
- `handsSinceRotation` が 6 到達時に `mixIndex` を更新。

### 2.3 index 定義

| mixIndex | gameType  |
| -------- | --------- |
| 0        | `HOLD_EM` |
| 1        | `OMAHA_8` |
| 2        | `RAZZ`    |
| 3        | `STUD_HI` |
| 4        | `STUD_8`  |

## 3. ハンド開始処理

1. 着席中で `ACTIVE` 条件を満たすプレイヤーを確定。
2. 最低参加人数（2人）未満なら `WAITING` 継続。
3. 現在 `mixIndex` の `gameType` を決定。
4. そのゲーム種別の配札ポリシーで初期配札。
5. first-to-act を算出しアクション待機へ遷移（算出ルールは `02_ゲームルール仕様_horse.md §4` を参照）。

## 4. ハンド終了処理

1. 終局（uncontested / showdown）を判定。
2. payout を計算し、スタック反映。
3. 履歴・イベントを永続化。
4. `handsSinceRotation += 1`。
5. `handsSinceRotation == 6` なら `mixIndex = (mixIndex + 1) % 5`、`handsSinceRotation = 0`。

## 5. Realtime 同期項目

- `table.status`
- `table.gameType`
- `table.mixIndex`
- `table.handsSinceRotation`
- `table.dealerSeatNo`
- `currentHand`（ゲーム種別依存情報を含む）

## 6. 例外系

- 全員離席または最低人数割れ: 現ハンド終了後 `WAITING`。
- 切断復帰: `table.resume` で最新 snapshot を取得し再同期。
- サーバ再起動: 永続化済み hand state から再開。

## 7. 受け入れ観点

- 30 ハンド連続実行で `0->1->2->3->4` の順が崩れない。
- 切替ハンド境界（6, 12, 18, ...）で `gameType` が正しい。
- 再接続時に `mixIndex` と `gameType` の不一致がない。
