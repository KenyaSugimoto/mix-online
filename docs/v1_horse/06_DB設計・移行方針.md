# Mix Online v1 DB設計・移行方針（HORSE）

> 作成日: 2026-02-13 ｜ 対象バージョン: v1 ｜ ステータス: Draft

## 1. 目的

HORSE 対応で必要なデータ構造を定義し、MVP から安全に移行する手順を示す。

## 2. 設計方針

- MVP スキーマを破壊せず、加算的変更を優先。
- ゲーム固有情報はイベント payload と専用補助テーブルで表現。
- 参照頻度が高い情報は冗長保持を許容し、読み出し最適化を優先。

## 3. 主要差分（案）

### 3.1 enum 拡張

- `game_type` に以下を追加:
  - `HOLD_EM`
  - `OMAHA_8`

### 3.2 `tables` 拡張

- `mix_index` の運用範囲を `0..4` に拡張（列型は現行維持）。
- `hands_since_rotation` は現行 `0..5` を維持。

### 3.3 `hands` 拡張

- `street` の扱いをゲームファミリー対応にする。
- `metadata jsonb` を導入し、ゲーム依存情報を保持。

### 3.4 カード情報テーブル（新規案）

- `hand_player_private_cards`
  - `hand_id`, `seat_no`, `card_index`, `card`, `revealed_at`
- `hand_board_cards`
  - `hand_id`, `street`, `board_index`, `card`

備考:
- Stud 系は board を使わないため `hand_board_cards` は 0 行。
- Flop 系は board 5枚を street ごとに保持。

## 4. 移行手順（段階導入）

1. enum/テーブル追加（未使用状態でデプロイ可能）。
2. サーバーを新カラム書き込み対応に更新。
3. 読み取りを新旧併用にし、整合確認。
4. v1 クライアントを段階リリース。
5. 旧参照ロジックを削除（十分な観測期間後）。

## 5. ロールバック方針

- 追加テーブル・追加列は後方互換を壊さないため、即時ロールバック可能。
- enum 追加後はアプリ側で未使用化して回避する。

## 6. インデックス方針

- `hands(table_id, hand_no desc)`
- `hands(game_type, started_at desc)`
- `hand_board_cards(hand_id, street, board_index)`
- `hand_player_private_cards(hand_id, seat_no, card_index)`

## 7. 監査・整合チェック

- hand 終了時に以下の整合を検証:
  - gameType と street 系列が一致
  - Flop 系で board 枚数が 5
  - Stud 系で board 行数が 0

## 8. 未決事項

- `metadata jsonb` と正規化テーブルの責務境界。
- 履歴 API の応答組み立てを SQL 主導で行うか、アプリ層で行うか。
