# Mix Online v1 状態遷移・ドメインモデル

> 作成日: 2026-02-13 ｜ 対象バージョン: v1 ｜ ステータス: Draft

## 1. 目的

ゲーム種別が増えても一貫した状態遷移を維持するため、v1 の状態モデルを定義する。

## 2. 主要エンティティ

- `Table`
- `TableSeat`
- `Hand`
- `HandPlayer`
- `HandEvent`
- `HandResult`
- `TableSnapshot`

## 3. 列挙体（主要）

- `GameType`: `HOLD_EM`, `OMAHA_8`, `RAZZ`, `STUD_HI`, `STUD_8`
- `TableStatus`: `WAITING`, `DEALING`, `BETTING`, `SHOWDOWN`, `HAND_END`
- `SeatStatus`: `EMPTY`, `SEATED_WAIT_NEXT_HAND`, `ACTIVE`, `SIT_OUT`, `DISCONNECTED`, `LEAVE_PENDING`
- `HandStatus`: `IN_PROGRESS`, `SHOWDOWN`, `HAND_END`
- `StreetGroup`: `FLOP_FAMILY`, `STUD_FAMILY`

## 4. テーブル状態遷移

`WAITING -> DEALING -> BETTING -> SHOWDOWN -> HAND_END -> DEALING`

補足:
- 参加人数不足時は `WAITING` に戻る。
- ハンド終局直後にローテーションカウンタ更新。

## 5. 席状態遷移

`EMPTY -> SEATED_WAIT_NEXT_HAND -> ACTIVE -> (SIT_OUT | DISCONNECTED | LEAVE_PENDING) -> EMPTY`

補足:
- `DISCONNECTED` は復帰時に `ACTIVE` または `SEATED_WAIT_NEXT_HAND` へ復元。
- `LEAVE_PENDING` はハンド終端で `EMPTY` 化。

## 6. ハンド状態遷移

`IN_PROGRESS -> SHOWDOWN -> HAND_END`

補足:
- 全員 fold で uncontested の場合は `SHOWDOWN` を経由せず `HAND_END` 可。

## 7. ゲームファミリー別状態

### 7.1 FLOP 系（HOLD_EM, OMAHA_8）

- Street: `PRE_FLOP`, `FLOP`, `TURN`, `RIVER`, `SHOWDOWN`
- board 公開イベントを持つ。

### 7.2 STUD 系（RAZZ, STUD_HI, STUD_8）

- Street: `THIRD`, `FOURTH`, `FIFTH`, `SIXTH`, `SEVENTH`, `SHOWDOWN`
- bring-in 局面を持つ。

## 8. ドメイン不変条件

- `gameType` と street family は矛盾しない。
- `mixIndex` は `0..4`。
- `handsSinceRotation` は `0..5`。
- `currentHand.gameType == table.gameType`。

## 9. 実装ガイド

- `Hand` はゲーム固有 payload を持てる構造にする。
- `HandEvent` は共通 envelope + ゲーム固有 payload の二層に分ける。
- UI は `StreetGroup` をキーに表示切替する。
