# Mix Online 要件定義書（v1 HORSE）

> 作成日: 2026-02-13 ｜ 対象バージョン: v1 ｜ ステータス: Draft

## 1. 目的

v1 で HORSE 5種を安定提供し、MVP で構築した Stud 中心の基盤を拡張可能な形で完成させる。

## 2. 対象ゲーム

| GameType  | 名称                          | 勝敗方式    | 形式 |
| --------- | ----------------------------- | ----------- | ---- |
| `HOLD_EM` | Limit Hold'em                 | High        | Flop |
| `OMAHA_8` | Limit Omaha Hi-Lo 8 or Better | Hi/Lo split | Flop |
| `RAZZ`    | Razz                          | Low         | Stud |
| `STUD_HI` | 7 Card Stud                   | High        | Stud |
| `STUD_8`  | Stud Hi-Lo 8 or Better        | Hi/Lo split | Stud |

## 3. スコープ

### 3.1 v1 対象

- HORSE 5種のゲーム進行。
- 6ハンドごとのローテーション。
- `FIXED_LIMIT` ベッティング。
- Realtime 同期、再接続復元、履歴閲覧。
- 既存ユーザー認証/着席/離席フローとの統合。

### 3.2 v1 対象外

- No-Limit / Pot-Limit。
- トーナメント。
- 観戦モード高度化。
- 独自卓作成UI（管理者運用を除く）。

## 4. 機能要件

### 4.1 ロビー/卓一覧

- 現在ゲーム種別、次切替までの残りハンド数を表示。
- ゲーム種別ごとのアイコン/ラベルを提供。

### 4.2 卓参加

- 着席条件、buy-in 範囲、満席判定は MVP と同一原則。
- 進行中参加は次ハンドから有効化。

### 4.3 ゲーム進行

- HORSE 順序でゲームが切替。
- 各ゲームの Street 構成と合法アクションを厳密に判定。
- 全員 All-in 時は残りカードを自動ランアウトして終局。

### 4.4 ショーダウン/分配

- High-only / Low-only / Hi-Lo split をゲーム種別に応じて判定。
- odd chip は既存運用（Hi 優先、同側は dealer 起点）を継続。

### 4.5 Realtime / 再接続

- 卓単位 `tableSeq` による順序保証。
- 欠番検知時の `table.resume` と `table.snapshot` の整合。

### 4.6 履歴閲覧

- gameType, handNo, 参加者, 結果, 損益を取得できること。
- Flop 系は board と hole 情報、Stud 系は up/down 構成が再現可能であること。

## 5. 非機能要件

### 5.1 信頼性

- サーバ再起動後に進行中ハンド復元可能。
- ハンド確定時の結果永続化が原子的であること。

### 5.2 性能

- Realtime イベント配信で体感遅延を抑える（MVP 目標を踏襲）。
- ロビー一覧・履歴一覧はページングで取得。

### 5.3 保守性

- ゲーム固有ロジックを `GameRule` 実装として分離。
- 共通進行エンジンはゲーム非依存 API を維持。

## 6. 互換性要件

- MVP クライアント互換を壊さない加算的拡張を優先。
- 破壊的変更が必要な場合のみ、v1 契約内で明示し移行手順を提供。
- enum 追加に対してクライアント側のデフォルト処理を定義する。

## 7. 運用要件

- 仕様変更時は `docs/v1_horse` 内の関連文書を同時更新。
- 回帰観点は `08_E2Eシナリオ集_v1_horse.md` を正本とする。

## 8. 未決事項（初版）

- `HOLD_EM` / `OMAHA_8` の bring-in 相当概念は存在しないため、UI 表示切替条件の最終名寄せ。
- Hi/Lo 片側不成立時の履歴表示フォーマット統一。
